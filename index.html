<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labirin Nilai Tempat - Matematika Kelas 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
        }
        
        .menu-button {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        
        .game-cell {
            width: 50px;
            height: 50px;
            border: 1px solid #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .wall {
            background-color: #334155;
        }
        
        .path {
            background-color: #e0f2fe;
        }
        
        .player {
            background-color: #22c55e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            position: absolute;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .monster {
            background-color: #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            position: absolute;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .answer {
            background-color: #fef3c7;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .answer:hover {
            background-color: #fde68a;
        }
        
        .correct-answer {
            background-color: #86efac;
        }
        
        .wrong-answer {
            background-color: #fca5a5;
        }
        
        .start {
            background-color: #a5f3fc;
        }
        
        .finish {
            background-color: #c4b5fd;
        }
        
        .game-container {
            position: relative;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .game-board {
            display: grid;
            margin: 0 auto;
        }
        
        .star {
            position: absolute;
            color: #fcd34d;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(360deg); opacity: 0; }
        }
        
        .rank-item {
            transition: transform 0.2s;
        }
        
        .rank-item:hover {
            transform: scale(1.02);
        }
        
        .material-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .key-control {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: #e2e8f0;
            border-radius: 6px;
            border: 2px solid #94a3b8;
            font-weight: bold;
            box-shadow: 0 2px 0 #94a3b8;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .answer-room {
            background-color: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 4px;
        }

        .control-btn {
            -webkit-tap-highlight-color: transparent; /* Menghilangkan highlight saat disentuh */
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <h1 class="text-2xl md:text-3xl font-bold">Labirin Nilai Tempat</h1>
                </div>
                <div class="flex space-x-2">
                    <button id="btn-materi" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition">Materi</button>
                    <button id="btn-game" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition">Game</button>
                    <button id="btn-ranking" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition">Ranking</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-4">
            <!-- Home Screen -->
            <div id="home-screen" class="flex flex-col items-center justify-center h-full py-8">
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold text-blue-700 mb-4">Selamat Datang di Labirin Nilai Tempat!</h2>
                    <p class="text-xl text-gray-600">Petualangan seru belajar matematika untuk kelas 4</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-4xl">
                    <div class="menu-button bg-gradient-to-br from-green-400 to-green-600 rounded-xl shadow-lg p-6 text-white text-center cursor-pointer" onclick="showScreen('materi-screen')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <h3 class="text-2xl font-bold mb-2">Materi</h3>
                        <p>Pelajari konsep nilai tempat dengan cara yang menyenangkan</p>
                    </div>
                    
                    <div class="menu-button bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl shadow-lg p-6 text-white text-center cursor-pointer" onclick="showScreen('game-screen')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="text-2xl font-bold mb-2">Game</h3>
                        <p>Mainkan game labirin dan hindari raksasa yang mengejarmu!</p>
                    </div>
                    
                    <div class="menu-button bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl shadow-lg p-6 text-white text-center cursor-pointer" onclick="showScreen('ranking-screen')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                        </svg>
                        <h3 class="text-2xl font-bold mb-2">Ranking</h3>
                        <p>Lihat siapa yang mendapatkan skor tertinggi</p>
                    </div>
                </div>
            </div>

            <!-- Materi Screen -->
            <div id="materi-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-blue-700">Materi Nilai Tempat</h2>
                    <button class="back-button bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center" onclick="showScreen('home-screen')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Kembali
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="material-card bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-blue-600 mb-4">Apa itu Nilai Tempat?</h3>
                        <p class="text-gray-700 mb-4">Nilai tempat adalah nilai yang dimiliki oleh sebuah angka berdasarkan posisinya dalam suatu bilangan. Dalam sistem desimal, setiap posisi memiliki nilai 10 kali lebih besar dari posisi di sebelah kanannya.</p>
                        
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <h4 class="font-bold text-blue-700 mb-2">Contoh:</h4>
                            <p class="text-gray-700">Pada bilangan 2.345:</p>
                            <ul class="list-disc list-inside text-gray-700 mt-2">
                                <li>Angka 5 berada di tempat satuan, nilainya 5 × 1 = 5</li>
                                <li>Angka 4 berada di tempat puluhan, nilainya 4 × 10 = 40</li>
                                <li>Angka 3 berada di tempat ratusan, nilainya 3 × 100 = 300</li>
                                <li>Angka 2 berada di tempat ribuan, nilainya 2 × 1000 = 2000</li>
                            </ul>
                        </div>
                        
                        <div class="flex justify-center">
                            <table class="border-collapse border border-blue-300 text-center">
                                <thead>
                                    <tr class="bg-blue-100">
                                        <th class="border border-blue-300 p-2 w-24">Ribuan</th>
                                        <th class="border border-blue-300 p-2 w-24">Ratusan</th>
                                        <th class="border border-blue-300 p-2 w-24">Puluhan</th>
                                        <th class="border border-blue-300 p-2 w-24">Satuan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-blue-300 p-3 text-2xl font-bold text-blue-700">2</td>
                                        <td class="border border-blue-300 p-3 text-2xl font-bold text-blue-700">3</td>
                                        <td class="border border-blue-300 p-3 text-2xl font-bold text-blue-700">4</td>
                                        <td class="border border-blue-300 p-3 text-2xl font-bold text-blue-700">5</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="material-card bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-green-600 mb-4">Mengapa Nilai Tempat Penting?</h3>
                        <p class="text-gray-700 mb-4">Memahami nilai tempat sangat penting karena:</p>
                        <ul class="list-disc list-inside text-gray-700 mb-6 space-y-2">
                            <li>Membantu kita membaca dan menulis bilangan dengan benar</li>
                            <li>Memudahkan kita melakukan operasi matematika seperti penjumlahan dan pengurangan</li>
                            <li>Membantu kita memahami konsep desimal dan pecahan</li>
                            <li>Menjadi dasar untuk memahami konsep matematika yang lebih kompleks</li>
                        </ul>
                        
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-700 mb-2">Latihan Cepat:</h4>
                            <p class="text-gray-700 mb-3">Pada bilangan 5.678, berapakah nilai tempat dari angka 6?</p>
                            <div class="flex space-x-4 mb-4">
                                <button class="nilai-tempat-option bg-white border border-green-300 hover:bg-green-100 text-green-700 px-4 py-2 rounded-lg" data-correct="false">Ribuan</button>
                                <button class="nilai-tempat-option bg-white border border-green-300 hover:bg-green-100 text-green-700 px-4 py-2 rounded-lg" data-correct="true">Ratusan</button>
                                <button class="nilai-tempat-option bg-white border border-green-300 hover:bg-green-100 text-green-700 px-4 py-2 rounded-lg" data-correct="false">Puluhan</button>
                                <button class="nilai-tempat-option bg-white border border-green-300 hover:bg-green-100 text-green-700 px-4 py-2 rounded-lg" data-correct="false">Satuan</button>
                            </div>
                            <div id="nilai-tempat-feedback" class="hidden p-3 rounded-lg text-center font-semibold"></div>
                        </div>
                    </div>
                </div>
                
                <div class="material-card bg-white rounded-xl shadow-lg p-6 mt-8">
                    <h3 class="text-2xl font-bold text-purple-600 mb-4">Contoh Soal dan Pilihan Jawaban</h3>
                    <p class="text-gray-600 mb-4">Berikut adalah beberapa contoh soal seperti di dalam game. Jawaban yang benar ditandai dengan warna hijau.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-700 mb-2">Soal 1:</h4>
                            <p class="text-gray-700 mb-3">Pada bilangan 4.729, angka yang menempati nilai tempat puluhan adalah...</p>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">4</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">7</button>
                                <button class="bg-green-200 border border-green-500 text-green-800 px-4 py-2 rounded-lg font-bold text-center">2</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">9</button>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-700 mb-2">Soal 2:</h4>
                            <p class="text-gray-700 mb-3">Nilai angka 7 pada bilangan 3.756 adalah...</p>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">7</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">70</button>
                                <button class="bg-green-200 border border-green-500 text-green-800 px-4 py-2 rounded-lg font-bold text-center">700</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">7000</button>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-700 mb-2">Soal 3:</h4>
                            <p class="text-gray-700 mb-3">Bilangan 8.425 dapat diuraikan menjadi...</p>
                            <div class="grid grid-cols-1 gap-2 mt-2">
                                <button class="bg-green-200 border border-green-500 text-green-800 px-4 py-2 rounded-lg font-bold text-center text-sm">8000 + 400 + 20 + 5</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center text-sm">800 + 40 + 2 + 5</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center text-sm">8000 + 40 + 25</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center text-sm">8 + 4 + 2 + 5</button>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-700 mb-2">Soal 4:</h4>
                            <p class="text-gray-700 mb-3">Pada bilangan 6.394, angka yang nilainya 90 adalah...</p>
                             <div class="grid grid-cols-2 gap-2 mt-2">
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">6</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">3</button>
                                <button class="bg-green-200 border border-green-500 text-green-800 px-4 py-2 rounded-lg font-bold text-center">9</button>
                                <button class="bg-white border border-purple-300 text-purple-700 px-4 py-2 rounded-lg text-center">4</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <button class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-bold text-lg" onclick="showScreen('game-screen')">
                            Ayo Main Game Labirin!
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-blue-700">Game Labirin Nilai Tempat</h2>
                    <button class="back-button bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center" onclick="showScreen('home-screen')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Kembali
                    </button>
                </div>

                <!-- Player Registration -->
                <div id="player-registration" class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-2xl font-bold text-blue-700 mb-4">Masukkan Nama Pemain</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="text" id="register-player-name" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nama kamu">
                        <button id="btn-register-player" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">
                            Daftar
                        </button>
                    </div>
                </div>

                <!-- Game Rules -->
                <div id="game-rules" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
                    <h3 class="text-2xl font-bold text-blue-700 mb-4">Aturan Permainan</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-700 mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                </svg>
                                Tujuan Permainan
                            </h4>
                            <p class="text-gray-700">Temukan jawaban yang benar dari pertanyaan nilai tempat yang diberikan. Hindari raksasa yang mengejarmu!</p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-700 mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
                                </svg>
                                Cara Bermain
                            </h4>
                            <p class="text-gray-700">Gunakan tombol panah pada keyboard untuk bergerak di dalam labirin. Kamu bisa juga mengklik jawaban yang kamu anggap benar.</p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-700 mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                </svg>
                                Perhatian
                            </h4>
                            <p class="text-gray-700">Raksasa akan mengejarmu! Jika raksasa menangkapmu atau waktu habis, permainan berakhir. Jawaban yang salah akan mengembalikanmu ke posisi awal.</p>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-700 mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                Skor
                            </h4>
                            <p class="text-gray-700">Skor dihitung berdasarkan waktu yang tersisa dan level yang kamu capai. Setiap pemain akan mendapatkan 10 soal acak dari total 15 soal yang tersedia.</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-bold text-yellow-700 mb-2">Kontrol Permainan:</h4>
                        <p class="text-center text-gray-600 mb-2">Gunakan tombol panah di keyboard (PC) atau tombol kontrol di layar (HP).</p>
                        <div class="flex flex-wrap justify-center gap-2 mb-4">
                            <div class="flex flex-col items-center">
                                <div class="key-control">↑</div>
                                <span class="text-sm mt-1">Atas</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="key-control">←</div>
                                <span class="text-sm mt-1">Kiri</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="key-control">↓</div>
                                <span class="text-sm mt-1">Bawah</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <div class="key-control">→</div>
                                <span class="text-sm mt-1">Kanan</span>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white mr-2">😊</div>
                                <span class="mr-6">Kamu</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white mr-2">👹</div>
                                <span>Raksasa</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button id="btn-start-game" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold text-lg pulse">
                            Mulai Game
                        </button>
                    </div>
                </div>

                <div id="game-container" class="bg-white rounded-xl shadow-lg p-6 hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div class="mb-4 md:mb-0">
                            <div id="game-player-name" class="text-lg font-semibold text-gray-700 mb-2">Pemain: </div>
                            <div id="game-question" class="text-xl font-bold text-blue-700 mb-2">Pertanyaan: Berapakah nilai tempat angka 7 pada bilangan 3.752?</div>
                            <div id="game-level" class="text-gray-600">Level: 1/10</div>
                        </div>
                        <div class="flex space-x-4">
                            <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg">
                                <span class="font-bold">Skor:</span> <span id="game-score">0</span>
                            </div>
                            <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg">
                                <span class="font-bold">Waktu:</span> <span id="game-timer">30</span>s
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center">
                        <div class="game-container">
                            <div id="game-board" class="game-board"></div>
                            <div id="player" class="player">😊</div>
                            <div id="monster" class="monster">👹</div>
                        </div>

                        <!-- Touch Controls for Mobile -->
                        <div id="touch-controls" class="mt-6 grid grid-cols-3 gap-2 w-48 mx-auto md:hidden">
                            <div></div>
                            <button id="btn-up" class="control-btn bg-blue-500 text-white text-2xl rounded-lg shadow-lg active:bg-blue-700 h-14">▲</button>
                            <div></div>
                            <button id="btn-left" class="control-btn bg-blue-500 text-white text-2xl rounded-lg shadow-lg active:bg-blue-700 h-14">◀</button>
                            <div></div>
                            <button id="btn-right" class="control-btn bg-blue-500 text-white text-2xl rounded-lg shadow-lg active:bg-blue-700 h-14">▶</button>
                            <div></div>
                            <button id="btn-down" class="control-btn bg-blue-500 text-white text-2xl rounded-lg shadow-lg active:bg-blue-700 h-14">▼</button>
                            <div></div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-center">
                        <button id="btn-next-level" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold text-lg hidden">
                            Level Berikutnya
                        </button>
                    </div>
                </div>

                <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                        <h3 id="game-over-title" class="text-3xl font-bold text-center mb-4">Game Over!</h3>
                        <p id="game-over-message" class="text-xl text-gray-700 text-center mb-6">Kamu berhasil menyelesaikan permainan!</p>
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Nama:</span>
                                <span id="final-name" class="font-bold text-blue-700">-</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Skor Akhir:</span>
                                <span id="final-score" class="font-bold text-blue-700">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">Level Tercapai:</span>
                                <span id="final-level" class="font-bold text-blue-700">1</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg" onclick="closeGameOverModal()">
                                Tutup
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg" onclick="restartGame()">
                                Main Lagi
                            </button>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" onclick="saveScore()">
                                Simpan Skor
                            </button>
                        </div>
                    </div>
                </div>

                <div id="save-score-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                        <h3 class="text-2xl font-bold text-center mb-4">Simpan Skor Kamu</h3>
                        <div class="mb-4">
                            <label for="player-name" class="block text-gray-700 mb-2">Nama:</label>
                            <input type="text" id="player-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan nama kamu">
                        </div>
                        <div class="flex justify-between">
                            <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg" onclick="closeSaveScoreModal()">
                                Batal
                            </button>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg" onclick="submitScore()">
                                Simpan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ranking Screen -->
            <div id="ranking-screen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-blue-700">Ranking Pemain</h2>
                    <button class="back-button bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center" onclick="showScreen('home-screen')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Kembali
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <!-- Podium Section -->
                    <div id="podium-container" class="flex justify-center items-end gap-2 md:gap-4 mb-8">
                        <!-- 2nd Place -->
                        <div id="podium-2" class="text-center order-2">
                            <div class="bg-slate-400 text-white p-2 md:p-4 rounded-t-lg shadow-lg">
                                <div class="text-2xl font-bold">🥈</div>
                                <div id="podium-name-2" class="font-semibold text-sm md:text-base truncate">-</div>
                                <div id="podium-score-2" class="text-sm md:text-lg">0</div>
                            </div>
                            <div class="bg-slate-500 text-white font-bold text-xl md:text-2xl p-4 w-24 md:w-32 h-24 flex items-center justify-center rounded-b-lg">2</div>
                        </div>
                        <!-- 1st Place -->
                        <div id="podium-1" class="text-center order-1">
                            <div class="bg-amber-400 text-white p-4 md:p-6 rounded-t-lg shadow-lg">
                                <div class="text-3xl font-bold">🥇</div>
                                <div id="podium-name-1" class="font-semibold text-base md:text-lg truncate">-</div>
                                <div id="podium-score-1" class="text-base md:text-xl">0</div>
                            </div>
                            <div class="bg-amber-500 text-white font-bold text-2xl md:text-3xl p-6 w-28 md:w-40 h-32 flex items-center justify-center rounded-b-lg">1</div>
                        </div>
                        <!-- 3rd Place -->
                        <div id="podium-3" class="text-center order-3">
                            <div class="bg-amber-600 text-white p-2 md:p-3 rounded-t-lg shadow-lg">
                                <div class="text-xl font-bold">🥉</div>
                                <div id="podium-name-3" class="font-semibold text-sm md:text-base truncate">-</div>
                                <div id="podium-score-3" class="text-sm md:text-lg">0</div>
                            </div>
                            <div class="bg-amber-700 text-white font-bold text-lg md:text-xl p-3 w-20 md:w-28 h-20 flex items-center justify-center rounded-b-lg">3</div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="bg-blue-100 text-blue-700">
                                    <th class="py-3 px-4 text-left">Peringkat</th>
                                    <th class="py-3 px-4 text-left">Nama</th>
                                    <th class="py-3 px-4 text-left">Skor</th>
                                    <th class="py-3 px-4 text-left">Level</th>
                                    <th class="py-3 px-4 text-left">Tanggal</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-table-body">
                                <!-- Ranking data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="no-rankings" class="text-center py-8 text-gray-500 hidden">
                        Belum ada data ranking. Mainkan game untuk menambahkan skor kamu!
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white p-4 mt-8">
            <div class="container mx-auto text-center">
                <p>&copy; 2025 Cikgu Junid</p>
            </div>
        </footer>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, limit, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        // These global variables are provided by the execution environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyBfouKaruU-PNGH8zgG8D9yy-htDrvmLiQ", authDomain: "labirin-nilai-tempat.firebaseapp.com", projectId: "labirin-nilai-tempat", storageBucket: "labirin-nilai-tempat.firebasestorage.app", messagingSenderId: "238358120888", appId: "1:238358120888:web:db5698984d915415a2274d" };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let rankingsCollection;
        let userId;

        // --- Authentication ---
        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // Path for public data (rankings)
                rankingsCollection = collection(db, `artifacts/${appId}/public/data/rankings`);
                listenForRankings(); // Start listening for ranking updates
            } else {
                userId = null;
                console.log("User is signed out.");
            }
        });

        // --- Firestore Listener ---
        function listenForRankings() {
            if (!rankingsCollection) return;
            // Create a query to get the top 50 scores, ordered by score descending
            const rankingsQuery = query(collection(db, `artifacts/${appId}/public/data/rankings`));

            onSnapshot(rankingsQuery, (snapshot) => {
                let fetchedRankings = [];
                snapshot.forEach((doc) => {
                    fetchedRankings.push({ id: doc.id, ...doc.data() });
                });
                // Sort by score descending, then by date ascending as a tie-breaker
                fetchedRankings.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return new Date(a.date) - new Date(b.date);
                });
                
                rankings = fetchedRankings.slice(0, 50); // Keep only top 50
                displayRankings(); // Update the UI with the new rankings
            }, (error) => {
                console.error("Error fetching rankings: ", error);
            });
        }
        
        // --- Game Logic (remains mostly the same) ---
        // Game variables
        let currentScreen = 'home-screen';
        let gameStarted = false;
        let gameInterval;
        let monsterInterval;
        let currentLevel = 1;
        let score = 0;
        let timeLeft = 30; // Waktu diubah menjadi 30 detik
        let maze = [];
        let playerPosition = { x: 0, y: 0 };
        let monsterPosition = { x: 0, y: 0 };
        let correctAnswer = '';
        let playerName = '';
        let selectedQuestions = [];
        let totalQuestions = 10; // Number of questions per game
        let rankings = []; // Correctly declare rankings variable
        
        // All available questions (15 total)
        let allGameQuestions = [
            { question: "Pada bilangan 2.475, nilai tempat angka 7 adalah?", answers: ["Ribuan", "Ratusan", "Puluhan", "Satuan"], correct: "Puluhan" },
            { question: "Angka yang menempati nilai tempat ratusan pada bilangan 4.629 adalah?", answers: ["4", "6", "2", "9"], correct: "6" },
            { question: "Nilai angka 8 pada bilangan 2.843 adalah?", answers: ["8", "80", "800", "8000"], correct: "800" },
            { question: "Pada bilangan 5.376, angka yang nilainya 70 adalah?", answers: ["7", "3", "6", "5"], correct: "7" },
            { question: "Bilangan 6.294 dapat diuraikan menjadi?", answers: ["6000+200+90+4", "6000+290+4", "6000+200+94", "6294"], correct: "6000+200+90+4" },
            { question: "Nilai tempat angka 5 pada bilangan 9.514 adalah?", answers: ["Satuan", "Puluhan", "Ratusan", "Ribuan"], correct: "Puluhan" },
            { question: "Pada bilangan 7.836, angka yang memiliki nilai 800 adalah?", answers: ["8", "3", "6", "7"], correct: "8" },
            { question: "Bilangan 4.275 terdiri dari?", answers: ["4 ribuan, 2 ratusan, 7 puluhan, 5 satuan", "4 ribuan, 27 puluhan, 5 satuan", "42 ratusan, 75 satuan", "4 ribuan, 275 satuan"], correct: "4 ribuan, 2 ratusan, 7 puluhan, 5 satuan" },
            { question: "Nilai tempat angka 9 pada bilangan 3.967 adalah?", answers: ["Satuan", "Puluhan", "Ratusan", "Ribuan"], correct: "Puluhan" },
            { question: "Pada bilangan 1.234, jumlah nilai angka 2 dan 3 adalah?", answers: ["5", "23", "50", "230"], correct: "230" },
            { question: "Pada bilangan 8.152, angka yang menempati nilai tempat satuan adalah?", answers: ["8", "1", "5", "2"], correct: "2" },
            { question: "Nilai angka 6 pada bilangan 3.648 adalah?", answers: ["6", "60", "600", "6000"], correct: "600" },
            { question: "Pada bilangan 9.073, angka yang nilainya 9000 adalah?", answers: ["9", "0", "7", "3"], correct: "9" },
            { question: "Bilangan 5.321 dapat diuraikan menjadi?", answers: ["5000+300+20+1", "5000+321", "5+3+2+1", "5321"], correct: "5000+300+20+1" },
            { question: "Nilai tempat angka 4 pada bilangan 7.462 adalah?", answers: ["Satuan", "Puluhan", "Ratusan", "Ribuan"], correct: "Ratusan" }
        ];
        
        // Show screen function
        window.showScreen = function(screenId) {
            document.getElementById(currentScreen).classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;
            
            if (screenId === 'ranking-screen') {
                displayRankings();
            }
            
            if (screenId === 'game-screen') {
                document.getElementById('player-registration').classList.remove('hidden');
                document.getElementById('game-rules').classList.add('hidden');
                document.getElementById('game-container').classList.add('hidden');
                resetGame();
            }
        }
        
        // Initialize the game
        function initGame() {
            // Set up event listeners
            document.getElementById('btn-materi').addEventListener('click', () => showScreen('materi-screen'));
            document.getElementById('btn-game').addEventListener('click', () => showScreen('game-screen'));
            document.getElementById('btn-ranking').addEventListener('click', () => showScreen('ranking-screen'));
            document.getElementById('btn-register-player').addEventListener('click', registerPlayer);
            document.getElementById('btn-start-game').addEventListener('click', startGame);
            document.getElementById('btn-next-level').addEventListener('click', nextLevel);
            
            const nilaiTempatOptions = document.querySelectorAll('.nilai-tempat-option');
            nilaiTempatOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const isCorrect = this.getAttribute('data-correct') === 'true';
                    const feedback = document.getElementById('nilai-tempat-feedback');
                    nilaiTempatOptions.forEach(opt => {
                        opt.disabled = true;
                        if (opt.getAttribute('data-correct') === 'true') {
                            opt.classList.add('bg-green-200', 'border-green-500');
                        }
                    });
                    if (isCorrect) {
                        feedback.textContent = 'Benar! Angka 6 berada di tempat ratusan, sehingga nilainya 6 × 100 = 600';
                        feedback.classList.add('bg-green-100', 'text-green-800');
                    } else {
                        feedback.textContent = 'Belum tepat. Angka 6 berada di tempat ratusan, sehingga nilainya 6 × 100 = 600';
                        feedback.classList.add('bg-red-100', 'text-red-800');
                        this.classList.add('bg-red-200', 'border-red-500');
                    }
                    feedback.classList.remove('hidden');
                });
            });

            document.getElementById('btn-up').addEventListener('click', () => movePlayer('up'));
            document.getElementById('btn-down').addEventListener('click', () => movePlayer('down'));
            document.getElementById('btn-left').addEventListener('click', () => movePlayer('left'));
            document.getElementById('btn-right').addEventListener('click', () => movePlayer('right'));
            
            selectRandomQuestions();
            createMaze();
        }
        
        function selectRandomQuestions() {
            const shuffledQuestions = [...allGameQuestions].sort(() => Math.random() - 0.5);
            selectedQuestions = shuffledQuestions.slice(0, totalQuestions);
        }
        
        function registerPlayer() {
            const nameInput = document.getElementById('register-player-name');
            const name = nameInput.value.trim();
            if (name) {
                playerName = name;
                document.getElementById('player-registration').classList.add('hidden');
                document.getElementById('game-rules').classList.remove('hidden');
                document.getElementById('game-player-name').textContent = `Pemain: ${playerName}`;
            } else {
                nameInput.classList.add('border-red-500');
                nameInput.placeholder = "Nama harus diisi!";
                setTimeout(() => {
                    nameInput.classList.remove('border-red-500');
                    nameInput.placeholder = "Nama kamu";
                }, 2000);
            }
        }

        function createMaze() {
            const mazeSize = 11;
            maze = [];
            for (let y = 0; y < mazeSize; y++) {
                const row = [];
                for (let x = 0; x < mazeSize; x++) {
                    if (x === 0 || y === 0 || x === mazeSize - 1 || y === mazeSize - 1) {
                        row.push('wall');
                    } else {
                        row.push('path');
                    }
                }
                maze.push(row);
            }
            const center = Math.floor(mazeSize / 2);
            playerPosition = { x: center, y: center };
            monsterPosition = { x: 1, y: 1 };
            const answerPositions = [ { x: 2, y: 2 }, { x: 8, y: 2 }, { x: 2, y: 8 }, { x: 8, y: 8 } ];
            const currentQuestion = selectedQuestions[currentLevel - 1];
            correctAnswer = currentQuestion.correct;
            const shuffledAnswers = [...currentQuestion.answers].sort(() => Math.random() - 0.5);
            for (let i = 0; i < answerPositions.length; i++) {
                const pos = answerPositions[i];
                const answerText = shuffledAnswers[i];
                if((pos.x === playerPosition.x && pos.y === playerPosition.y) || (pos.x === monsterPosition.x && pos.y === monsterPosition.y)) {
                    pos.x = (pos.x + 1) % (mazeSize - 2) + 1; 
                }
                maze[pos.y][pos.x] = { type: 'answer', text: answerText, correct: answerText === correctAnswer };
            }
            maze[playerPosition.y][playerPosition.x] = 'start';
            renderMaze();
        }
        
        function renderMaze() {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${maze[0].length}, 50px)`;
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'game-cell';
                    const cellType = maze[y][x];
                    if (cellType === 'wall') cell.classList.add('wall');
                    else if (cellType === 'path') cell.classList.add('path');
                    else if (cellType === 'start') {
                        cell.classList.add('start');
                        cell.textContent = 'S';
                    } else if (typeof cellType === 'object' && cellType.type === 'answer') {
                        cell.classList.add('answer', 'answer-room');
                        cell.textContent = cellType.text;
                        cell.dataset.correct = cellType.correct;
                        cell.addEventListener('click', () => checkAnswer(x, y, cellType.correct));
                    }
                    gameBoard.appendChild(cell);
                }
            }
            updatePlayerPosition();
            updateMonsterPosition();
        }
        
        function updatePlayerPosition() {
            const player = document.getElementById('player');
            const cellSize = 50;
            player.style.left = `${playerPosition.x * cellSize + 5}px`;
            player.style.top = `${playerPosition.y * cellSize + 5}px`;
        }
        
        function updateMonsterPosition() {
            const monster = document.getElementById('monster');
            const cellSize = 50;
            monster.style.left = `${monsterPosition.x * cellSize + 5}px`;
            monster.style.top = `${monsterPosition.y * cellSize + 5}px`;
        }
        
        window.movePlayer = function(direction) {
            if (!gameStarted) return;
            let newX = playerPosition.x, newY = playerPosition.y;
            switch (direction) {
                case 'up': newY--; break;
                case 'down': newY++; break;
                case 'left': newX--; break;
                case 'right': newX++; break;
            }
            if (newX >= 0 && newX < maze[0].length && newY >= 0 && newY < maze.length) {
                const cellType = maze[newY][newX];
                if (cellType !== 'wall') {
                    playerPosition.x = newX;
                    playerPosition.y = newY;
                    updatePlayerPosition();
                    if (typeof cellType === 'object' && cellType.type === 'answer') {
                        checkAnswer(newX, newY, cellType.correct);
                    }
                }
            }
        }
        
        function moveMonster() {
            if (!gameStarted) return;
            const dx = playerPosition.x - monsterPosition.x;
            const dy = playerPosition.y - monsterPosition.y;
            let newX = monsterPosition.x, newY = monsterPosition.y;
            if (Math.abs(dx) > Math.abs(dy)) newX += dx > 0 ? 1 : -1;
            else newY += dy > 0 ? 1 : -1;
            if (newX > 0 && newX < maze[0].length - 1 && newY > 0 && newY < maze.length - 1) {
                monsterPosition.x = newX;
                monsterPosition.y = newY;
                updateMonsterPosition();
                if (monsterPosition.x === playerPosition.x && monsterPosition.y === playerPosition.y) {
                    endGame(false, "Kamu tertangkap raksasa!");
                }
            }
        }
        
        function checkAnswer(x, y, isCorrect) {
            if (!gameStarted) return;
            if (isCorrect) {
                score += Math.floor(timeLeft * 10);
                document.getElementById('game-score').textContent = score;
                showSuccessAnimation(x, y);
                endLevel(true);
            } else {
                score -= 50;
                if (score < 0) score = 0;
                document.getElementById('game-score').textContent = score;
                showWrongAnimation(x, y);
                const center = Math.floor(maze[0].length / 2);
                playerPosition = { x: center, y: center };
                updatePlayerPosition();
            }
        }
        
        function showSuccessAnimation(x, y) {
            const cellSize = 50;
            const centerX = x * cellSize + 25, centerY = y * cellSize + 25;
            for (let i = 0; i < 10; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.textContent = '⭐';
                star.style.fontSize = `${Math.random() * 20 + 10}px`;
                star.style.left = `${centerX + (Math.random() * 100 - 50)}px`;
                star.style.top = `${centerY + (Math.random() * 100 - 50)}px`;
                document.querySelector('.game-container').appendChild(star);
                setTimeout(() => star.remove(), 2000);
            }
        }
        
        function showWrongAnimation(x, y) {
            const index = y * maze[0].length + x + 1;
            const cell = document.querySelector(`#game-board .game-cell:nth-child(${index})`);
            if (cell) {
                cell.classList.add('wrong-answer');
                setTimeout(() => cell.classList.remove('wrong-answer'), 1000);
            }
        }
        
        function startGame() {
            if (gameStarted) return;
            gameStarted = true;
            document.getElementById('game-rules').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.addEventListener('keydown', handleKeyPress);
            gameInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').textContent = timeLeft;
                if (timeLeft <= 0) endGame(false, "Waktu habis!");
            }, 1000);
            monsterInterval = setInterval(moveMonster, 500);
            document.getElementById('game-question').textContent = `Pertanyaan: ${selectedQuestions[currentLevel - 1].question}`;
            document.getElementById('game-level').textContent = `Level: ${currentLevel}/${totalQuestions}`;
        }
        
        function handleKeyPress(e) {
            if (!gameStarted) return;
            switch (e.key) {
                case 'ArrowUp': movePlayer('up'); break;
                case 'ArrowDown': movePlayer('down'); break;
                case 'ArrowLeft': movePlayer('left'); break;
                case 'ArrowRight': movePlayer('right'); break;
            }
        }
        
        function endLevel(success) {
            clearInterval(gameInterval);
            clearInterval(monsterInterval);
            gameStarted = false;
            if (success) {
                if (currentLevel < totalQuestions) {
                    document.getElementById('btn-next-level').classList.remove('hidden');
                } else {
                    endGame(true, "Selamat! Kamu berhasil menyelesaikan semua level!");
                }
            } else {
                endGame(false, "Game Over!");
            }
        }
        
        window.nextLevel = function() {
            currentLevel++;
            timeLeft = 30;
            document.getElementById('game-timer').textContent = timeLeft;
            document.getElementById('btn-next-level').classList.add('hidden');
            createMaze();
            startGame();
        }
        
        function endGame(success, message) {
            clearInterval(gameInterval);
            clearInterval(monsterInterval);
            gameStarted = false;
            document.getElementById('final-name').textContent = playerName;
            document.getElementById('final-score').textContent = score;
            document.getElementById('final-level').textContent = currentLevel;
            if (success) {
                document.getElementById('game-over-title').textContent = 'Selamat!';
                document.getElementById('game-over-message').textContent = message;
                showConfetti();
            } else {
                document.getElementById('game-over-title').textContent = 'Game Over!';
                document.getElementById('game-over-message').textContent = message;
            }
            document.getElementById('game-over-modal').classList.remove('hidden');
        }
        
        function showConfetti() {
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }
        
        window.closeGameOverModal = function() {
            document.getElementById('game-over-modal').classList.add('hidden');
            resetGame();
            showScreen('home-screen');
        }
        
        window.restartGame = function() {
            document.getElementById('game-over-modal').classList.add('hidden');
            resetGame();
            document.getElementById('game-rules').classList.remove('hidden');
            document.getElementById('game-container').classList.add('hidden');
        }
        
        function resetGame() {
            gameStarted = false;
            currentLevel = 1;
            score = 0;
            timeLeft = 30;
            document.getElementById('game-score').textContent = score;
            document.getElementById('game-timer').textContent = timeLeft;
            document.getElementById('game-level').textContent = `Level: ${currentLevel}/${totalQuestions}`;
            document.getElementById('btn-next-level').classList.add('hidden');
            selectRandomQuestions();
            createMaze();
        }
        
        window.saveScore = function() {
            document.getElementById('game-over-modal').classList.add('hidden');
            document.getElementById('player-name').value = playerName;
            document.getElementById('save-score-modal').classList.remove('hidden');
        }
        
        window.closeSaveScoreModal = function() {
            document.getElementById('save-score-modal').classList.add('hidden');
            resetGame();
            showScreen('home-screen');
        }
        
        window.submitScore = async function() {
            if (!rankingsCollection) {
                console.error("Firestore is not initialized.");
                return;
            }
            const playerNameInput = document.getElementById('player-name').value.trim();
            if (playerNameInput) {
                const newScore = {
                    name: playerNameInput,
                    score: score,
                    level: currentLevel,
                    date: new Date().toISOString() // Use ISO string for consistent sorting
                };
                try {
                    // Use userId as the document ID to prevent duplicate entries per user
                    // This will create a new entry or overwrite the existing one for the user
                    await setDoc(doc(rankingsCollection, userId), newScore);
                    document.getElementById('save-score-modal').classList.add('hidden');
                    showScreen('ranking-screen');
                } catch (error) {
                    console.error("Error writing document: ", error);
                }
            }
        }
        
        function displayRankings() {
            const podiumContainer = document.getElementById('podium-container');
            const tableBody = document.getElementById('ranking-table-body');
            const noRankings = document.getElementById('no-rankings');
            const table = document.querySelector('#ranking-screen table');
            tableBody.innerHTML = '';
            document.getElementById('podium-name-1').textContent = '-';
            document.getElementById('podium-score-1').textContent = 'Skor: 0';
            document.getElementById('podium-name-2').textContent = '-';
            document.getElementById('podium-score-2').textContent = 'Skor: 0';
            document.getElementById('podium-name-3').textContent = '-';
            document.getElementById('podium-score-3').textContent = 'Skor: 0';
            if (rankings.length === 0) {
                noRankings.classList.remove('hidden');
                podiumContainer.classList.add('hidden');
                table.classList.add('hidden');
            } else {
                noRankings.classList.add('hidden');
                podiumContainer.classList.remove('hidden');
                table.classList.remove('hidden');
                if (rankings[0]) {
                    document.getElementById('podium-name-1').textContent = rankings[0].name;
                    document.getElementById('podium-score-1').textContent = `Skor: ${rankings[0].score}`;
                }
                if (rankings[1]) {
                    document.getElementById('podium-name-2').textContent = rankings[1].name;
                    document.getElementById('podium-score-2').textContent = `Skor: ${rankings[1].score}`;
                }
                if (rankings[2]) {
                    document.getElementById('podium-name-3').textContent = rankings[2].name;
                    document.getElementById('podium-score-3').textContent = `Skor: ${rankings[2].score}`;
                }
                const tableRankings = rankings.slice(3);
                tableRankings.forEach((rank, index) => {
                    const row = document.createElement('tr');
                    row.className = 'rank-item border-b hover:bg-blue-50';
                    const rankDisplay = `${index + 4}`;
                    row.innerHTML = `
                        <td class="py-3 px-4">${rankDisplay}</td>
                        <td class="py-3 px-4 font-semibold">${rank.name}</td>
                        <td class="py-3 px-4 font-bold text-blue-700">${rank.score}</td>
                        <td class="py-3 px-4">${rank.level}</td>
                        <td class="py-3 px-4 text-gray-500">${new Date(rank.date).toLocaleDateString()}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        // Initialize the app on window load
        window.onload = async () => {
            await initializeAuth();
            initGame();
        };

    </script>
</body>
</html>
